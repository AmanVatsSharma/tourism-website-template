---
/**
 * Schema Markup Component
 * 
 * Generates JSON-LD structured data for SEO
 * Types: organization, faq, localbusiness, article
 */

import { loadJSON } from '../utils/dataLoader';

interface Props {
  type: 'organization' | 'faq' | 'localbusiness' | 'article' | 'website' | 'breadcrumbs';
  articleData?: {
    title: string;
    description: string;
    image: string;
    datePublished: string;
    dateModified: string;
    author: string;
  };
}

const { type, articleData } = Astro.props;

console.log('[SchemaMarkup] Generating schema for type:', type);

let schemaData: any = null;

try {
  if (type === 'organization' || type === 'localbusiness') {
    schemaData = await loadJSON('organization_schema.json');
    console.log('[SchemaMarkup] ✓ Organization schema loaded');
  } else if (type === 'faq') {
    schemaData = await loadJSON('faq_schema.json');
    console.log('[SchemaMarkup] ✓ FAQ schema loaded');
  } else if (type === 'website') {
    const origin = Astro.site?.origin || 'https://www.shivyaatrakailash.in';
    schemaData = {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "url": origin + '/',
      "name": "Shiv Yatra Tourism",
      "potentialAction": {
        "@type": "SearchAction",
        "target": origin + '/search?q={search_term_string}',
        "query-input": "required name=search_term_string"
      }
    };
    console.log('[SchemaMarkup] ✓ WebSite schema generated');
  } else if (type === 'breadcrumbs') {
    const origin = Astro.site?.origin || 'https://www.shivyaatrakailash.in';
    const path = Astro.url.pathname;
    const isHindi = path === '/hi' || path.startsWith('/hi/');
    const basePath = isHindi ? path.replace(/^\/hi/, '') || '/' : path;
    const segments = basePath.split('/').filter(Boolean);
    const items = [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": origin + '/'
      },
      ...segments.map((seg, idx) => {
        const name = seg.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        const url = origin + '/' + segments.slice(0, idx + 1).join('/');
        return {
          "@type": "ListItem",
          "position": idx + 2,
          "name": name,
          "item": url
        };
      })
    ];
    schemaData = {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": items
    };
    console.log('[SchemaMarkup] ✓ BreadcrumbList schema generated');
  }
} catch (error) {
  console.error('[SchemaMarkup] ✗ Failed to load schema:', error);
}

// Generate Article schema if type is 'article' and articleData is provided
let articleSchema = null;
if (type === 'article' && articleData) {
  articleSchema = {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": articleData.title,
    "description": articleData.description,
    "image": articleData.image,
    "datePublished": articleData.datePublished,
    "dateModified": articleData.dateModified,
    "author": {
      "@type": "Organization",
      "name": articleData.author || "Shiv Yatra Tourism",
      "url": "https://www.shivyaatrakailash.in"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Shiv Yatra Tourism",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.shivyaatrakailash.in/favicon.svg"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": Astro.url.href
    }
  };
  console.log('[SchemaMarkup] ✓ Article schema generated');
}

// Add LocalBusiness enhancements if type is localbusiness
if (type === 'localbusiness' && schemaData) {
  schemaData["@type"] = ["Organization", "LocalBusiness", "TravelAgency"];
  schemaData["geo"] = {
    "@type": "GeoCoordinates",
    "latitude": "29.8469",
    "longitude": "80.5420"
  };
  schemaData["openingHoursSpecification"] = {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": [
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday"
    ],
    "opens": "09:00",
    "closes": "19:00"
  };
  console.log('[SchemaMarkup] ✓ LocalBusiness schema enhanced');
}
---

{schemaData && (
  <script type="application/ld+json" set:html={JSON.stringify(schemaData, null, 2)} />
)}

{articleSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema, null, 2)} />
)}

{!schemaData && !articleSchema && (
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Shiv Yatra Tourism",
    "url": "https://www.shivyaatrakailash.in",
    "logo": "https://www.shivyaatrakailash.in/favicon.svg",
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "+91-7302937532",
      "contactType": "Customer Service",
      "areaServed": "IN",
      "availableLanguage": ["en", "hi"]
    }
  }
  </script>
)}

